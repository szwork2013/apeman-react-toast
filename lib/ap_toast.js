/**
 * Toast components.
 * @constructor ApToast
 */

"use strict";

const React = require('react'),
      extend = require('extend'),
      classnames = require('classnames'),
      arrayfilter = require('arrayfilter'),
      types = React.PropTypes,
      ApTouchable = require('apeman-react-touchable')['ApTouchable'],
      ApIcon = require('apeman-react-icon')['ApIcon'];

/** @lends ApToast */
let ApToast = React.createClass({
    displayName: 'ApToast',

    //--------------------
    // Specs
    //--------------------

    propTypes: {
        message: types.string,
        duration: types.number,
        icon: types.string
    },

    mixins: [],

    statics: {
        itemJoiner: '____'
    },

    getInitialState: function () {
        return {
            items: ''
        };
    },

    getDefaultProps: function () {
        return {
            message: null,
            duration: 2000,
            icon: null
        };
    },

    render: function () {
        let s = this,
            state = s.state,
            props = s.props;

        let valid = state.items.length;
        if (!valid) {
            return null;
        }
        return React.createElement(
            'div',
            { className: classnames('ap-toast', props.className, {}),
                style: extend({}, props.style) },
            React.createElement(
                'div',
                { className: 'ap-toast-inner' },
                s._renderToastItem()
            )
        );
    },

    //--------------------
    // Lifecycle
    //--------------------

    componentWillMount: function () {
        let s = this;
    },

    componentDidMount: function () {
        let s = this,
            props = s.props;
        s.startTicking();
        s.pushToastItem(props.message);
    },

    componentWillReceiveProps: function (nextProps) {
        let s = this;
        s.pushToastItem(nextProps.message);
    },

    shouldComponentUpdate: function (nextProps, nextState) {
        let s = this;
        return true;
    },

    componentWillUpdate: function (nextProps, nextState) {
        let s = this;
    },

    componentDidUpdate: function (prevProps, prevState) {
        let s = this;
    },

    componentWillUnmount: function () {
        let s = this;
        s.stopTicking();
    },

    //------------------
    // Helper
    //------------------
    startTicking: function () {
        let s = this;
        clearTimeout(s._tickTimer);
        s._ticking = true;
        s.doTick();
    },
    stopTicking: function () {
        let s = this;
        clearTimeout(s._tickTimer);
        s._ticking = false;
    },
    doTick: function () {
        let s = this,
            props = s.props;
        if (!s._ticking) {
            return;
        }
        s._tickTimer = setTimeout(() => {
            s.shiftToastItem();
            s.doTick();
        }, props.duration);
    },
    pushToastItem: function (message) {
        let s = this;
        if (!message) {
            return;
        }
        let items = (s.state.items || '').split(ApToast.itemJoiner);
        let duplicate = items[items.length - 1] === message;
        if (duplicate) {
            return;
        }
        s.setState({
            items: items.concat(message).join(ApToast.itemJoiner)
        });
    },
    shiftToastItem: function () {
        let s = this;
        let items = (s.state.items || '').split(ApToast.itemJoiner);
        if (!items.length) {
            return;
        }
        s.setState({
            items: items.slice(1).join(ApToast.itemJoiner)
        });
    },
    dismissToastItem: function (message) {
        let s = this;
        let items = (s.state.items || '').split(ApToast.itemJoiner);
        s.setState({
            items: items.filter(filtering => {
                return filtering != message;
            }).join(ApToast.itemJoiner)
        });
    },
    //------------------
    // Private
    //------------------
    _ticking: false,
    _tickTimer: null,
    _renderToastItem: function () {
        let s = this,
            props = s.props,
            state = s.state;
        return (state.items || '').split(ApToast.itemJoiner).filter(arrayfilter.emptyReject()).map((text, i) => {
            return React.createElement(
                'div',
                { key: `toast-${ text }` },
                React.createElement(
                    ApTouchable,
                    { onTap: () => s.dismissToastItem(text) },
                    React.createElement(
                        'div',
                        { className: 'ap-toast-item' },
                        React.createElement(ApIcon, { className: classnames('ap-toast-item-icon', props.icon) }),
                        React.createElement(
                            'span',
                            { className: 'ap-toast-text' },
                            text
                        )
                    )
                )
            );
        });
    }
});

module.exports = ApToast;
//# sourceMappingURL=data:application/json;base64,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LENBQUMsVUFBVSxDQUFDO1NBQzlCLENBQUMsQ0FBQztLQUNOOzs7O0FBSUQsWUFBUSxFQUFFLEtBQUs7QUFDZixjQUFVLEVBQUUsSUFBSTtBQUNoQixvQkFBZ0IsRUFBRSxZQUFZO0FBQzFCLFlBQUksQ0FBQyxHQUFHLElBQUk7WUFDUixLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUs7WUFDZixLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUNwQixlQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUEsQ0FBRSxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLO0FBQ3BHLG1CQUNJOztrQkFBSyxHQUFHLEVBQUUsQ0FBQyxNQUFNLEdBQUUsSUFBSSxFQUFDLENBQUMsQUFBQztnQkFDdEI7QUFBQywrQkFBVztzQkFBQyxLQUFLLEVBQUUsTUFBSSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEFBQUM7b0JBQzdDOzswQkFBSyxTQUFTLEVBQUMsZUFBZTt3QkFDMUIsb0JBQUMsTUFBTSxJQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxBQUFDLEdBQUU7d0JBQ2xFOzs4QkFBTSxTQUFTLEVBQUMsZUFBZTs0QkFBRSxJQUFJO3lCQUFRO3FCQUMzQztpQkFDSTthQUNaLENBQ1Q7U0FDSixDQUFDLENBQUM7S0FDTjtDQUNKLENBQUMsQ0FBQzs7QUFFSCxNQUFNLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyIsImZpbGUiOiJhcF90b2FzdC5qcyIsInNvdXJjZVJvb3QiOiIvVXNlcnMvb2t1bmlzaGl0YWthL3Byb2plY3RzL2FwZW1hbi1yZWFjdC1sYWJvL2FwZW1hbi1yZWFjdC10b2FzdC9saWIvanN4Iiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUb2FzdCBjb21wb25lbnRzLlxuICogQGNvbnN0cnVjdG9yIEFwVG9hc3RcbiAqL1xuXG5cInVzZSBzdHJpY3RcIjtcblxuY29uc3QgUmVhY3QgPSByZXF1aXJlKCdyZWFjdCcpLFxuICAgIGV4dGVuZCA9IHJlcXVpcmUoJ2V4dGVuZCcpLFxuICAgIGNsYXNzbmFtZXMgPSByZXF1aXJlKCdjbGFzc25hbWVzJyksXG4gICAgYXJyYXlmaWx0ZXIgPSByZXF1aXJlKCdhcnJheWZpbHRlcicpLFxuICAgIHR5cGVzID0gUmVhY3QuUHJvcFR5cGVzLFxuICAgIEFwVG91Y2hhYmxlID0gcmVxdWlyZSgnYXBlbWFuLXJlYWN0LXRvdWNoYWJsZScpWydBcFRvdWNoYWJsZSddLFxuICAgIEFwSWNvbiA9IHJlcXVpcmUoJ2FwZW1hbi1yZWFjdC1pY29uJylbJ0FwSWNvbiddO1xuXG4vKiogQGxlbmRzIEFwVG9hc3QgKi9cbmxldCBBcFRvYXN0ID0gUmVhY3QuY3JlYXRlQ2xhc3Moe1xuXG5cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gU3BlY3NcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICBwcm9wVHlwZXM6IHtcbiAgICAgICAgbWVzc2FnZTogdHlwZXMuc3RyaW5nLFxuICAgICAgICBkdXJhdGlvbjogdHlwZXMubnVtYmVyLFxuICAgICAgICBpY29uOiB0eXBlcy5zdHJpbmdcbiAgICB9LFxuXG4gICAgbWl4aW5zOiBbXSxcblxuICAgIHN0YXRpY3M6IHtcbiAgICAgICAgaXRlbUpvaW5lcjogJ19fX18nXG4gICAgfSxcblxuICAgIGdldEluaXRpYWxTdGF0ZTogZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaXRlbXM6ICcnXG4gICAgICAgIH07XG4gICAgfSxcblxuICAgIGdldERlZmF1bHRQcm9wczogZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbWVzc2FnZTogbnVsbCxcbiAgICAgICAgICAgIGR1cmF0aW9uOiAyMDAwLFxuICAgICAgICAgICAgaWNvbjogbnVsbFxuICAgICAgICB9O1xuICAgIH0sXG5cbiAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzLFxuICAgICAgICAgICAgc3RhdGUgPSBzLnN0YXRlLFxuICAgICAgICAgICAgcHJvcHMgPSBzLnByb3BzO1xuXG4gICAgICAgIGxldCB2YWxpZCA9IHN0YXRlLml0ZW1zLmxlbmd0aDtcbiAgICAgICAgaWYgKCF2YWxpZCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc25hbWVzKCdhcC10b2FzdCcsIHByb3BzLmNsYXNzTmFtZSwge1xuXG4gICAgICAgICAgICB9KX1cbiAgICAgICAgICAgICAgICAgc3R5bGU9e2V4dGVuZCh7fSwgcHJvcHMuc3R5bGUpfT5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImFwLXRvYXN0LWlubmVyXCI+XG4gICAgICAgICAgICAgICAgICAgIHtzLl9yZW5kZXJUb2FzdEl0ZW0oKX1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH0sXG5cblxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBMaWZlY3ljbGVcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICBjb21wb25lbnRXaWxsTW91bnQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuICAgIH0sXG5cbiAgICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgcyA9IHRoaXMsXG4gICAgICAgICAgICBwcm9wcyA9IHMucHJvcHM7XG4gICAgICAgIHMuc3RhcnRUaWNraW5nKCk7XG4gICAgICAgIHMucHVzaFRvYXN0SXRlbShwcm9wcy5tZXNzYWdlKTtcbiAgICB9LFxuXG4gICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wczogZnVuY3Rpb24gKG5leHRQcm9wcykge1xuICAgICAgICBsZXQgcyA9IHRoaXM7XG4gICAgICAgIHMucHVzaFRvYXN0SXRlbShuZXh0UHJvcHMubWVzc2FnZSk7XG4gICAgfSxcblxuICAgIHNob3VsZENvbXBvbmVudFVwZGF0ZTogZnVuY3Rpb24gKG5leHRQcm9wcywgbmV4dFN0YXRlKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSxcblxuICAgIGNvbXBvbmVudFdpbGxVcGRhdGU6IGZ1bmN0aW9uIChuZXh0UHJvcHMsIG5leHRTdGF0ZSkge1xuICAgICAgICBsZXQgcyA9IHRoaXM7XG4gICAgfSxcblxuICAgIGNvbXBvbmVudERpZFVwZGF0ZTogZnVuY3Rpb24gKHByZXZQcm9wcywgcHJldlN0YXRlKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICB9LFxuXG4gICAgY29tcG9uZW50V2lsbFVubW91bnQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuICAgICAgICBzLnN0b3BUaWNraW5nKCk7XG4gICAgfSxcblxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gSGVscGVyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBzdGFydFRpY2tpbmc6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuICAgICAgICBjbGVhclRpbWVvdXQocy5fdGlja1RpbWVyKTtcbiAgICAgICAgcy5fdGlja2luZyA9IHRydWU7XG4gICAgICAgIHMuZG9UaWNrKCk7XG4gICAgfSxcbiAgICBzdG9wVGlja2luZzogZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgcyA9IHRoaXM7XG4gICAgICAgIGNsZWFyVGltZW91dChzLl90aWNrVGltZXIpO1xuICAgICAgICBzLl90aWNraW5nID0gZmFsc2U7XG4gICAgfSxcbiAgICBkb1RpY2s6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzLFxuICAgICAgICAgICAgcHJvcHMgPSBzLnByb3BzO1xuICAgICAgICBpZiAoIXMuX3RpY2tpbmcpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBzLl90aWNrVGltZXIgPSBzZXRUaW1lb3V0KCgpPT4ge1xuICAgICAgICAgICAgcy5zaGlmdFRvYXN0SXRlbSgpO1xuICAgICAgICAgICAgcy5kb1RpY2soKTtcbiAgICAgICAgfSwgcHJvcHMuZHVyYXRpb24pO1xuICAgIH0sXG4gICAgcHVzaFRvYXN0SXRlbTogZnVuY3Rpb24gKG1lc3NhZ2UpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuICAgICAgICBpZiAoIW1lc3NhZ2UpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBsZXQgaXRlbXMgPSAocy5zdGF0ZS5pdGVtcyB8fCAnJykuc3BsaXQoQXBUb2FzdC5pdGVtSm9pbmVyKTtcbiAgICAgICAgbGV0IGR1cGxpY2F0ZSA9IGl0ZW1zW2l0ZW1zLmxlbmd0aCAtIDFdID09PSBtZXNzYWdlO1xuICAgICAgICBpZiAoZHVwbGljYXRlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBpdGVtczogaXRlbXMuY29uY2F0KG1lc3NhZ2UpLmpvaW4oQXBUb2FzdC5pdGVtSm9pbmVyKVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIHNoaWZ0VG9hc3RJdGVtOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICAgICAgbGV0IGl0ZW1zID0gKHMuc3RhdGUuaXRlbXMgfHwgJycpLnNwbGl0KEFwVG9hc3QuaXRlbUpvaW5lcik7XG4gICAgICAgIGlmICghaXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBpdGVtczogaXRlbXMuc2xpY2UoMSkuam9pbihBcFRvYXN0Lml0ZW1Kb2luZXIpXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgZGlzbWlzc1RvYXN0SXRlbTogZnVuY3Rpb24gKG1lc3NhZ2UpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuICAgICAgICBsZXQgaXRlbXMgPSAocy5zdGF0ZS5pdGVtcyB8fCAnJykuc3BsaXQoQXBUb2FzdC5pdGVtSm9pbmVyKTtcbiAgICAgICAgcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBpdGVtczogaXRlbXMuZmlsdGVyKChmaWx0ZXJpbmcpPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJpbmcgIT0gbWVzc2FnZTtcbiAgICAgICAgICAgIH0pLmpvaW4oQXBUb2FzdC5pdGVtSm9pbmVyKVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gUHJpdmF0ZVxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgX3RpY2tpbmc6IGZhbHNlLFxuICAgIF90aWNrVGltZXI6IG51bGwsXG4gICAgX3JlbmRlclRvYXN0SXRlbTogZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgcyA9IHRoaXMsXG4gICAgICAgICAgICBwcm9wcyA9IHMucHJvcHMsXG4gICAgICAgICAgICBzdGF0ZSA9IHMuc3RhdGU7XG4gICAgICAgIHJldHVybiAoc3RhdGUuaXRlbXMgfHwgJycpLnNwbGl0KEFwVG9hc3QuaXRlbUpvaW5lcikuZmlsdGVyKGFycmF5ZmlsdGVyLmVtcHR5UmVqZWN0KCkpLm1hcCgodGV4dCwgaSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8ZGl2IGtleT17YHRvYXN0LSR7dGV4dH1gfT5cbiAgICAgICAgICAgICAgICAgICAgPEFwVG91Y2hhYmxlIG9uVGFwPXsoKT0+cy5kaXNtaXNzVG9hc3RJdGVtKHRleHQpfT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiYXAtdG9hc3QtaXRlbVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxBcEljb24gY2xhc3NOYW1lPXtjbGFzc25hbWVzKCdhcC10b2FzdC1pdGVtLWljb24nLCBwcm9wcy5pY29uKX0vPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cImFwLXRvYXN0LXRleHRcIj57dGV4dH08L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPC9BcFRvdWNoYWJsZT5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIClcbiAgICAgICAgfSk7XG4gICAgfVxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gQXBUb2FzdDsiXX0=