/**
 * Toast components.
 * @constructor ApToast
 */

"use strict";

const React = require('react'),
      extend = require('extend'),
      classnames = require('classnames'),
      arrayfilter = require('arrayfilter'),
      types = React.PropTypes,
      ApTouchable = require('apeman-react-touchable')['ApTouchable'],
      ApIcon = require('apeman-react-icon')['ApIcon'];

/** @lends ApToast */
let ApToast = React.createClass({
    displayName: 'ApToast',

    //--------------------
    // Specs
    //--------------------

    propTypes: {
        message: types.string,
        duration: types.number,
        icon: types.string
    },

    mixins: [],

    statics: {},

    getInitialState: function () {
        return {
            items: ''
        };
    },

    getDefaultProps: function () {
        return {
            message: null,
            duration: 2000,
            icon: null
        };
    },

    render: function () {
        let s = this,
            state = s.state,
            props = s.props;

        let valid = state.items.length;
        if (!valid) {
            return null;
        }
        return React.createElement(
            'div',
            { className: classnames('ap-toast', props.className, {}),
                style: extend({}, props.style) },
            React.createElement(
                'div',
                { className: 'ap-toast-inner' },
                s._renderToastItem()
            )
        );
    },

    //--------------------
    // Lifecycle
    //--------------------

    componentWillMount: function () {
        let s = this;
    },

    componentDidMount: function () {
        let s = this,
            props = s.props;
        s.startTicking();
        s.pushToastItem(props.message);
    },

    componentWillReceiveProps: function (nextProps) {
        let s = this;
        s.pushToastItem(nextProps.message);
    },

    shouldComponentUpdate: function (nextProps, nextState) {
        let s = this;
        return true;
    },

    componentWillUpdate: function (nextProps, nextState) {
        let s = this;
    },

    componentDidUpdate: function (prevProps, prevState) {
        let s = this;
    },

    componentWillUnmount: function () {
        let s = this;
        s.stopTicking();
    },

    //------------------
    // Helper
    //------------------
    startTicking: function () {
        let s = this;
        clearTimeout(s._tickTimer);
        s._ticking = true;
        s.doTick();
    },
    stopTicking: function () {
        let s = this;
        clearTimeout(s._tickTimer);
        s._ticking = false;
    },
    doTick: function () {
        let s = this,
            props = s.props;
        if (!s._ticking) {
            return;
        }
        s._tickTimer = setTimeout(() => {
            s.shiftToastItem();
            s.doTick();
        }, props.duration);
    },
    pushToastItem: function (message) {
        let s = this;
        if (!message) {
            return;
        }
        let items = (s.state.items || '').split(',');
        let duplicate = items[items.length - 1] === message;
        if (duplicate) {
            return;
        }
        s.setState({
            items: items.concat(message).join(',')
        });
    },
    shiftToastItem: function () {
        let s = this;
        let items = (s.state.items || '').split(',');
        if (!items.length) {
            return;
        }
        s.setState({
            items: items.slice(1).join(',')
        });
    },
    dismissToastItem: function (message) {
        let s = this;
        let items = (s.state.items || '').split(',');
        s.setState({
            items: items.filter(filtering => {
                return filtering != message;
            })
        });
    },
    //------------------
    // Private
    //------------------
    _ticking: false,
    _tickTimer: null,
    _renderToastItem: function () {
        let s = this,
            props = s.props,
            state = s.state;
        return (state.items || '').split(',').filter(arrayfilter.emptyReject()).map((text, i) => {
            return React.createElement(
                'div',
                { key: `toast-${ i }` },
                React.createElement(
                    ApTouchable,
                    { onTap: () => s.dismissToastItem(text) },
                    React.createElement(
                        'div',
                        { className: 'ap-toast-item' },
                        React.createElement(ApIcon, { className: classnames('ap-toast-item-icon', props.icon) }),
                        React.createElement(
                            'span',
                            { className: 'ap-toast-text' },
                            text
                        )
                    )
                )
            );
        });
    }
});

module.exports = ApToast;
//# sourceMappingURL=data:application/json;base64,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LFlBQUksQ0FBQyxHQUFHLElBQUk7WUFDUixLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUs7WUFDZixLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUNwQixlQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUEsQ0FBRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLEtBQUs7QUFDckYsbUJBQ0k7O2tCQUFLLEdBQUcsRUFBRSxDQUFDLE1BQU0sR0FBRSxDQUFDLEVBQUMsQ0FBQyxBQUFDO2dCQUNuQjtBQUFDLCtCQUFXO3NCQUFDLEtBQUssRUFBRSxNQUFJLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQUFBQztvQkFDN0M7OzBCQUFLLFNBQVMsRUFBQyxlQUFlO3dCQUMxQixvQkFBQyxNQUFNLElBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxvQkFBb0IsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEFBQUMsR0FBRTt3QkFDbEU7OzhCQUFNLFNBQVMsRUFBQyxlQUFlOzRCQUFFLElBQUk7eUJBQVE7cUJBQzNDO2lCQUNJO2FBQ1osQ0FDVDtTQUNKLENBQUMsQ0FBQztLQUNOO0NBQ0osQ0FBQyxDQUFDOztBQUVILE1BQU0sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDIiwiZmlsZSI6ImFwX3RvYXN0LmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9va3VuaXNoaXRha2EvcHJvamVjdHMvYXBlbWFuLXJlYWN0LWxhYm8vYXBlbWFuLXJlYWN0LXRvYXN0L2xpYi9qc3giLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRvYXN0IGNvbXBvbmVudHMuXG4gKiBAY29uc3RydWN0b3IgQXBUb2FzdFxuICovXG5cblwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBSZWFjdCA9IHJlcXVpcmUoJ3JlYWN0JyksXG4gICAgZXh0ZW5kID0gcmVxdWlyZSgnZXh0ZW5kJyksXG4gICAgY2xhc3NuYW1lcyA9IHJlcXVpcmUoJ2NsYXNzbmFtZXMnKSxcbiAgICBhcnJheWZpbHRlciA9IHJlcXVpcmUoJ2FycmF5ZmlsdGVyJyksXG4gICAgdHlwZXMgPSBSZWFjdC5Qcm9wVHlwZXMsXG4gICAgQXBUb3VjaGFibGUgPSByZXF1aXJlKCdhcGVtYW4tcmVhY3QtdG91Y2hhYmxlJylbJ0FwVG91Y2hhYmxlJ10sXG4gICAgQXBJY29uID0gcmVxdWlyZSgnYXBlbWFuLXJlYWN0LWljb24nKVsnQXBJY29uJ107XG5cbi8qKiBAbGVuZHMgQXBUb2FzdCAqL1xubGV0IEFwVG9hc3QgPSBSZWFjdC5jcmVhdGVDbGFzcyh7XG5cblxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBTcGVjc1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAgIHByb3BUeXBlczoge1xuICAgICAgICBtZXNzYWdlOiB0eXBlcy5zdHJpbmcsXG4gICAgICAgIGR1cmF0aW9uOiB0eXBlcy5udW1iZXIsXG4gICAgICAgIGljb246IHR5cGVzLnN0cmluZ1xuICAgIH0sXG5cbiAgICBtaXhpbnM6IFtdLFxuXG4gICAgc3RhdGljczoge30sXG5cbiAgICBnZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGl0ZW1zOiAnJ1xuICAgICAgICB9O1xuICAgIH0sXG5cbiAgICBnZXREZWZhdWx0UHJvcHM6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IG51bGwsXG4gICAgICAgICAgICBkdXJhdGlvbjogMjAwMCxcbiAgICAgICAgICAgIGljb246IG51bGxcbiAgICAgICAgfTtcbiAgICB9LFxuXG4gICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxldCBzID0gdGhpcyxcbiAgICAgICAgICAgIHN0YXRlID0gcy5zdGF0ZSxcbiAgICAgICAgICAgIHByb3BzID0gcy5wcm9wcztcblxuICAgICAgICBsZXQgdmFsaWQgPSBzdGF0ZS5pdGVtcy5sZW5ndGg7XG4gICAgICAgIGlmICghdmFsaWQpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3NuYW1lcygnYXAtdG9hc3QnLCBwcm9wcy5jbGFzc05hbWUsIHtcblxuICAgICAgICAgICAgfSl9XG4gICAgICAgICAgICAgICAgIHN0eWxlPXtleHRlbmQoe30sIHByb3BzLnN0eWxlKX0+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJhcC10b2FzdC1pbm5lclwiPlxuICAgICAgICAgICAgICAgICAgICB7cy5fcmVuZGVyVG9hc3RJdGVtKCl9XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9LFxuXG5cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gTGlmZWN5Y2xlXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gICAgY29tcG9uZW50V2lsbE1vdW50OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICB9LFxuXG4gICAgY29tcG9uZW50RGlkTW91bnQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzLFxuICAgICAgICAgICAgcHJvcHMgPSBzLnByb3BzO1xuICAgICAgICBzLnN0YXJ0VGlja2luZygpO1xuICAgICAgICBzLnB1c2hUb2FzdEl0ZW0ocHJvcHMubWVzc2FnZSk7XG4gICAgfSxcblxuICAgIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHM6IGZ1bmN0aW9uIChuZXh0UHJvcHMpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuICAgICAgICBzLnB1c2hUb2FzdEl0ZW0obmV4dFByb3BzLm1lc3NhZ2UpO1xuICAgIH0sXG5cbiAgICBzaG91bGRDb21wb25lbnRVcGRhdGU6IGZ1bmN0aW9uIChuZXh0UHJvcHMsIG5leHRTdGF0ZSkge1xuICAgICAgICBsZXQgcyA9IHRoaXM7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH0sXG5cbiAgICBjb21wb25lbnRXaWxsVXBkYXRlOiBmdW5jdGlvbiAobmV4dFByb3BzLCBuZXh0U3RhdGUpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuICAgIH0sXG5cbiAgICBjb21wb25lbnREaWRVcGRhdGU6IGZ1bmN0aW9uIChwcmV2UHJvcHMsIHByZXZTdGF0ZSkge1xuICAgICAgICBsZXQgcyA9IHRoaXM7XG4gICAgfSxcblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICAgICAgcy5zdG9wVGlja2luZygpO1xuICAgIH0sXG5cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIEhlbHBlclxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgc3RhcnRUaWNraW5nOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICAgICAgY2xlYXJUaW1lb3V0KHMuX3RpY2tUaW1lcik7XG4gICAgICAgIHMuX3RpY2tpbmcgPSB0cnVlO1xuICAgICAgICBzLmRvVGljaygpO1xuICAgIH0sXG4gICAgc3RvcFRpY2tpbmc6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuICAgICAgICBjbGVhclRpbWVvdXQocy5fdGlja1RpbWVyKTtcbiAgICAgICAgcy5fdGlja2luZyA9IGZhbHNlO1xuICAgIH0sXG4gICAgZG9UaWNrOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxldCBzID0gdGhpcyxcbiAgICAgICAgICAgIHByb3BzID0gcy5wcm9wcztcbiAgICAgICAgaWYgKCFzLl90aWNraW5nKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgcy5fdGlja1RpbWVyID0gc2V0VGltZW91dCgoKT0+IHtcbiAgICAgICAgICAgIHMuc2hpZnRUb2FzdEl0ZW0oKTtcbiAgICAgICAgICAgIHMuZG9UaWNrKCk7XG4gICAgICAgIH0sIHByb3BzLmR1cmF0aW9uKTtcbiAgICB9LFxuICAgIHB1c2hUb2FzdEl0ZW06IGZ1bmN0aW9uIChtZXNzYWdlKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICAgICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGl0ZW1zID0gKHMuc3RhdGUuaXRlbXMgfHwgJycpLnNwbGl0KCcsJyk7XG4gICAgICAgIGxldCBkdXBsaWNhdGUgPSBpdGVtc1tpdGVtcy5sZW5ndGggLSAxXSA9PT0gbWVzc2FnZTtcbiAgICAgICAgaWYgKGR1cGxpY2F0ZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgaXRlbXM6IGl0ZW1zLmNvbmNhdChtZXNzYWdlKS5qb2luKCcsJylcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBzaGlmdFRvYXN0SXRlbTogZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgcyA9IHRoaXM7XG4gICAgICAgIGxldCBpdGVtcyA9IChzLnN0YXRlLml0ZW1zIHx8ICcnKS5zcGxpdCgnLCcpO1xuICAgICAgICBpZiAoIWl0ZW1zLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgaXRlbXM6IGl0ZW1zLnNsaWNlKDEpLmpvaW4oJywnKVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIGRpc21pc3NUb2FzdEl0ZW06IGZ1bmN0aW9uIChtZXNzYWdlKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICAgICAgbGV0IGl0ZW1zID0gKHMuc3RhdGUuaXRlbXMgfHwgJycpLnNwbGl0KCcsJyk7XG4gICAgICAgIHMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgaXRlbXM6IGl0ZW1zLmZpbHRlcigoZmlsdGVyaW5nKT0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmlsdGVyaW5nICE9IG1lc3NhZ2U7XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gUHJpdmF0ZVxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgX3RpY2tpbmc6IGZhbHNlLFxuICAgIF90aWNrVGltZXI6IG51bGwsXG4gICAgX3JlbmRlclRvYXN0SXRlbTogZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgcyA9IHRoaXMsXG4gICAgICAgICAgICBwcm9wcyA9IHMucHJvcHMsXG4gICAgICAgICAgICBzdGF0ZSA9IHMuc3RhdGU7XG4gICAgICAgIHJldHVybiAoc3RhdGUuaXRlbXMgfHwgJycpLnNwbGl0KCcsJykuZmlsdGVyKGFycmF5ZmlsdGVyLmVtcHR5UmVqZWN0KCkpLm1hcCgodGV4dCwgaSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8ZGl2IGtleT17YHRvYXN0LSR7aX1gfT5cbiAgICAgICAgICAgICAgICAgICAgPEFwVG91Y2hhYmxlIG9uVGFwPXsoKT0+cy5kaXNtaXNzVG9hc3RJdGVtKHRleHQpfT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiYXAtdG9hc3QtaXRlbVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxBcEljb24gY2xhc3NOYW1lPXtjbGFzc25hbWVzKCdhcC10b2FzdC1pdGVtLWljb24nLCBwcm9wcy5pY29uKX0vPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cImFwLXRvYXN0LXRleHRcIj57dGV4dH08L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPC9BcFRvdWNoYWJsZT5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIClcbiAgICAgICAgfSk7XG4gICAgfVxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gQXBUb2FzdDsiXX0=